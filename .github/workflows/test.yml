name: Test

on:
  push:
    branches: [main, master]
    paths-ignore: '**.md'
  pull_request:
    branches: [main, master]
    paths-ignore: '**.md'
  schedule:
    - cron: '30 3 * * 4'  # Weekly on Thursday
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # MacPorts version to use for testing
  # Change this value to test different MacPorts versions
  MACPORTS_VERSION: '2.12.0-rc1'

jobs:
  # Warm-up cache - runs once per platform to populate cache for all other jobs
  # Each platform has different cache keys (version/arch), so we run in parallel
  warm-up-cache:
    name: Warm-up cache (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts to populate cache
        id: setup
        uses: ./
        env:
          CACHE_SAVE_ONLY: 'true'
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          cache: 'true'

  # Code style checks (separate job to avoid blocking quick tests)
  style-check:
    name: Code style checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format-check

  # Quick tests on macOS (this action is macOS-only)
  quick-test:
    name: Quick tests (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
        node-version: [20.x]
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  # Build verification
  build:
    name: Verify build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Compare dist
        run: |
          if [ "$(git diff --name-only | grep dist/ | wc -l)" -gt "0" ]; then
            echo "üîç The following files have uncommitted changes:"
            git diff --name-only | grep dist/
            echo ""
            echo "üì¶ Dist folder size:"
            du -sh dist/
            echo ""
            echo "‚ö†Ô∏è Files changed since last commit:"
            git diff --stat -- 'dist/**'
            echo ""
            echo "‚ùå Detected uncommitted changes after build."
            echo "Please run 'npm run build' and commit the changes."
            exit 1
          fi
          echo "‚úÖ No uncommitted changes detected in dist/"

  # Comprehensive macOS tests with matrix
  test-macos:
    name: macOS ${{ matrix.label }}
    runs-on: ${{ matrix.runner }}
    needs: warm-up-cache
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            version: '14'
            arch: 'arm64'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            version: '15'
            arch: 'arm64'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            version: '15'
            arch: 'x86_64'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            version: '26'
            arch: 'arm64'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Detect platform
        id: platform
        run: |
          echo "version=$(sw_vers -productVersion | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "macos_name=$(sw_vers -productName)" >> $GITHUB_OUTPUT

      - name: Test basic installation
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          debug: 'true'

      - name: Verify basic installation
        run: |
          set -x
          /opt/local/bin/port version
          [ -x /opt/local/bin/port ] || exit 1
          echo "‚úÖ Port binary exists and is executable"

      - name: Test with variants
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'

      - name: Verify variants
        run: |
          set -x
          cat /opt/local/etc/macports/variants.conf
          # Check each variant exists in the file
          # Use -e flag for patterns starting with -
          grep -e '+doc' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '+x11' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '-universal' /opt/local/etc/macports/variants.conf || exit 1
          echo "‚úÖ Variants configured correctly"

      - name: Test git sources
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          use-git-sources: 'true'

      - name: Verify git sources
        run: |
          # Check that the ports directory exists
          [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
          # Check that sources.conf points to the local copy
          grep -q 'file://.*macports-ports' /opt/local/etc/macports/sources.conf || exit 1
          echo "‚úÖ Git sources configured"

      - name: Test port installation
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          install-ports: 'git-lfs inkscape'

      - name: Verify port installation
        run: |
          /opt/local/bin/port installed git-lfs || echo "git-lfs installation failed (expected rsync permission issue)"
          /opt/local/bin/port installed inkscape || echo "inkscape installation may have failed (complex port with many dependencies)"
          # Verify action still works even if ports fail
          /opt/local/bin/port version
          echo "‚úÖ MacPorts setup successful"

      - name: Display platform info
        run: |
          echo "Platform: ${{ steps.platform.outputs.macos_name }}"
          echo "Version: ${{ steps.platform.outputs.version }}"
          echo "Architecture: ${{ steps.platform.outputs.arch }}"
          echo "Runner: ${{ matrix.runner }}"

  # Test configuration outputs
  test-outputs:
    name: Configuration Outputs (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with variants and git sources
        id: setup
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'
          use-git-sources: 'true'

      - name: Test variants and git sources functionality
        run: |
          echo "=== Functional Test: Variants + Git Sources ==="
          echo ""
          echo "This test verifies:"
          echo "1. Variants system is functional"
          echo "2. Git sources are being used"
          echo "3. Configuration is applied correctly"
          echo ""

          # Test 1: Verify git sources are configured
          echo "Test 1: Git sources configuration"
          SOURCES_CONF="/opt/local/etc/macports/sources.conf"
          echo "sources.conf content:"
          cat "$SOURCES_CONF"
          echo ""
          if grep -q "file://.*/macports-ports" "$SOURCES_CONF"; then
            echo "‚úÖ Git sources are configured in sources.conf"
          else
            echo "‚ùå Git sources not configured in sources.conf"
            echo "Content:"
            cat "$SOURCES_CONF"
            exit 1
          fi

          # Test 2: Verify git sources are functional by checking PortIndex
          echo ""
          echo "Test 2: Git sources are functional"
          # Check that PortIndex exists (created during port sync)
          if [ -f "/opt/local/var/macports/sources/github.com/macports/macports-ports/PortIndex" ]; then
            echo "‚úÖ PortIndex exists - git sources are functional"
          else
            echo "‚ùå PortIndex not found - git sources may not be working"
            exit 1
          fi

          # Test 3: Verify variants were applied
          echo ""
          echo "Test 3: Variants configuration"
          VARIANTS_CONF="/opt/local/etc/macports/variants.conf"
          if [ -f "$VARIANTS_CONF" ]; then
            echo "variants.conf content:"
            cat "$VARIANTS_CONF"
            echo ""
            if grep -q '+doc' "$VARIANTS_CONF" && \
               grep -q '+x11' "$VARIANTS_CONF" && \
               grep -q '-universal' "$VARIANTS_CONF"; then
              echo "‚úÖ Variants configured correctly: +doc +x11 -universal"
            else
              echo "‚ùå Variants don't match expected: +doc +x11 -universal"
              exit 1
            fi
          else
            echo "‚ùå variants.conf not found"
            exit 1
          fi

          # Test 4: Verify MacPorts can query ports (basic functionality)
          echo ""
          echo "Test 4: MacPorts port query functionality"
          # Use 'port list' to verify sources are working
          # 'port info' without arguments tries to use current directory
          if OUTPUT=$(/opt/local/bin/port list 2>&1 | head -5); then
            echo "‚úÖ MacPorts port query is functional"
            echo "Sample ports:"
            echo "$OUTPUT"
          else
            echo "‚ùå MacPorts port query failed"
            echo "Error output:"
            echo "$OUTPUT"
            exit 1
          fi

          echo ""
          echo "=== All functional tests passed ==="
          echo "Variants work, git sources are functional, configuration is applied"

  # Test sources providers
  test-sources-providers:
    name: Sources Provider ${{ matrix.provider }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'auto'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'git'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'auto'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'git'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'auto'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'git'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'rsync'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'auto'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'git'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'rsync'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.provider }} provider
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          sources-provider: '${{ matrix.provider }}'

      - name: Verify sources configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check sources.conf content
          echo "=== sources.conf content ==="
          cat /opt/local/etc/macports/sources.conf

          # Verify provider-specific configuration
          if [ "${{ matrix.provider }}" = "git" ]; then
            # Git provider should have local git sources
            grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf || exit 1
            # Verify git repository exists
            [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
            echo "‚úÖ Git provider configured correctly"
          elif [ "${{ matrix.provider }}" = "rsync" ]; then
            # Rsync provider should have rsync URL
            grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf || exit 1
            echo "‚úÖ Rsync provider configured correctly"
          else
            # Auto provider should have either git or rsync
            if grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf; then
              echo "‚úÖ Auto provider chose git"
            elif grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf; then
              echo "‚úÖ Auto provider chose rsync"
            else
              exit 1
            fi
          fi

  # Test signature validation modes
  test-signature-modes:
    name: Signature Mode ${{ matrix.mode }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'strict'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'disabled'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'strict'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'disabled'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'strict'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'disabled'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'strict'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'disabled'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.mode }} signature mode
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          signature-check: '${{ matrix.mode }}'

      - name: Verify signature configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check macports.conf content
          echo "=== macports.conf content ==="
          cat /opt/local/etc/macports/macports.conf

          # Verify signature_check setting
          if [ "${{ matrix.mode }}" = "strict" ]; then
            grep -q "signature_check yes" /opt/local/etc/macports/macports.conf || exit 1
            echo "‚úÖ Strict mode: signature check enabled"
          elif [ "${{ matrix.mode }}" = "disabled" ]; then
            grep -q "signature_check no" /opt/local/etc/macports/macports.conf || exit 1
            echo "‚úÖ Disabled mode: signature check disabled"
          fi

  # Test custom prefix (experimental)
  test-custom-prefix:
    name: Custom Prefix (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with custom prefix
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          installation-prefix: '/tmp/macports-test'

      - name: Verify custom prefix installation
        run: |
          # Verify port binary exists at custom prefix
          # Note: Cannot run port binary due to hardcoded shebangs pointing to /opt/local
          test -x /tmp/macports-test/bin/port || exit 1
          test -f /tmp/macports-test/bin/port || exit 1

          # Verify configuration files at custom prefix
          test -f /tmp/macports-test/etc/macports/macports.conf || exit 1
          test -f /tmp/macports-test/etc/macports/sources.conf || exit 1
          test -f /tmp/macports-test/etc/macports/variants.conf || exit 1

          # Verify it's NOT in /opt/local
          ! test -f /opt/local/bin/port || exit 1

          # Verify prefix in macports.conf
          grep -q "prefix /tmp/macports-test" /tmp/macports-test/etc/macports/macports.conf || exit 1

          # Verify key directories were moved
          test -d /tmp/macports-test/bin || exit 1
          test -d /tmp/macports-test/sbin || exit 1
          test -d /tmp/macports-test/lib || exit 1
          test -d /tmp/macports-test/share || exit 1
          test -d /tmp/macports-test/var || exit 1

          echo "‚úÖ Custom prefix installation verified"
