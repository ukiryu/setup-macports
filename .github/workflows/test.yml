name: Test

on:
  push:
    branches: [main, master]
    paths-ignore: '**.md'
  pull_request:
    branches: [main, master]
    paths-ignore: '**.md'
  schedule:
    - cron: '30 3 * * 4'  # Weekly on Thursday
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # MacPorts version to use for testing
  # Change this value to test different MacPorts versions
  MACPORTS_VERSION: '2.12.0-rc1'

jobs:
  # Warm-up cache - runs once per platform to populate cache for all other jobs
  # Each platform has different cache keys (version/arch), so we run in parallel
  warm-up-cache:
    name: Warm-up cache (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts to populate cache
        id: setup
        uses: ./
        env:
          CACHE_SAVE_ONLY: 'true'
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          cache: 'true'

  # Code style checks (separate job to avoid blocking quick tests)
  style-check:
    name: Code style checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format-check

  # Quick tests on macOS (this action is macOS-only)
  quick-test:
    name: Quick tests (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
        node-version: [24.x]
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Run unit tests
        run: npm test

  # Build verification
  build:
    name: Verify build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Compare dist
        run: |
          if [ "$(git diff --name-only | grep dist/ | wc -l)" -gt "0" ]; then
            echo "ğŸ” The following files have uncommitted changes:"
            git diff --name-only | grep dist/
            echo ""
            echo "ğŸ“¦ Dist folder size:"
            du -sh dist/
            echo ""
            echo "âš ï¸ Files changed since last commit:"
            git diff --stat -- 'dist/**'
            echo ""
            echo "âŒ Detected uncommitted changes after build."
            echo "Please run 'npm run build' and commit the changes."
            exit 1
          fi
          echo "âœ… No uncommitted changes detected in dist/"

  # Comprehensive macOS tests with matrix
  test-macos:
    name: macOS ${{ matrix.label }}
    runs-on: ${{ matrix.runner }}
    needs: warm-up-cache
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            version: '14'
            arch: 'arm64'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            version: '15'
            arch: 'arm64'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            version: '15'
            arch: 'x86_64'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            version: '26'
            arch: 'arm64'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Detect platform
        id: platform
        run: |
          echo "version=$(sw_vers -productVersion | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "macos_name=$(sw_vers -productName)" >> $GITHUB_OUTPUT

      # ONE action call with all configurations
      - name: Setup MacPorts with all features
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'
          sources-provider: 'git'
          install-ports: 'git-lfs inkscape'

      # Verify basic installation
      - name: Verify basic installation
        run: |
          set -x
          /opt/local/bin/port version
          [ -x /opt/local/bin/port ] || exit 1
          echo "âœ… Port binary exists and is executable"

      # Verify variants
      - name: Verify variants
        run: |
          set -x
          cat /opt/local/etc/macports/variants.conf
          grep -e '+doc' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '+x11' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '-universal' /opt/local/etc/macports/variants.conf || exit 1
          echo "âœ… Variants configured correctly"

      # Verify git sources
      - name: Verify git sources
        run: |
          [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
          grep -q 'file://.*macports-ports' /opt/local/etc/macports/sources.conf || exit 1
          echo "âœ… Git sources configured"

      # Verify port installation - test actual CLI functionality
      - name: Verify port installation
        run: |
          echo "=== Verifying CLI functionality ==="
          echo "Note: Some ports may fail activation due to LaunchDaemon permissions in CI"
          echo "We test whether the CLI binary exists and is executable"

          # Test git-lfs CLI
          echo ""
          echo "Testing git-lfs:"
          if [ -x /opt/local/bin/git-lfs ]; then
            git-lfs --version
            echo "âœ… git-lfs CLI works"
          else
            echo "âš ï¸ git-lfs CLI not found (activation may have failed due to permissions)"
          fi

          # Test inkscape CLI
          echo ""
          echo "Testing inkscape:"
          if [ -x /opt/local/bin/inkscape ]; then
            inkscape --version 2>/dev/null || inkscape --help 2>&1 | head -3
            echo "âœ… Inkscape CLI exists"
          else
            echo "âš ï¸ Inkscape CLI not found (complex port with many dependencies, may have failed)"
          fi

          # Verify MacPorts itself works regardless of port installation results
          echo ""
          /opt/local/bin/port version
          echo "âœ… MacPorts setup successful"

      - name: Display platform info
        run: |
          echo "Platform: ${{ steps.platform.outputs.macos_name }}"
          echo "Version: ${{ steps.platform.outputs.version }}"
          echo "Architecture: ${{ steps.platform.outputs.arch }}"
          echo "Runner: ${{ matrix.runner }}"

  # Test configuration outputs
  test-outputs:
    name: Configuration Outputs (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with variants and git sources
        id: setup
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'
          sources-provider: 'git'

      - name: Test variants and git sources functionality
        run: |
          echo "=== Functional Test: Variants + Git Sources ==="
          echo ""
          echo "This test verifies:"
          echo "1. Variants system is functional"
          echo "2. Git sources are being used"
          echo "3. Configuration is applied correctly"
          echo ""

          # Test 1: Verify git sources are configured
          echo "Test 1: Git sources configuration"
          SOURCES_CONF="/opt/local/etc/macports/sources.conf"
          echo "sources.conf content:"
          cat "$SOURCES_CONF"
          echo ""
          if grep -q "file://.*/macports-ports" "$SOURCES_CONF"; then
            echo "âœ… Git sources are configured in sources.conf"
          else
            echo "âŒ Git sources not configured in sources.conf"
            echo "Content:"
            cat "$SOURCES_CONF"
            exit 1
          fi

          # Test 2: Verify git sources are functional by checking PortIndex
          echo ""
          echo "Test 2: Git sources are functional"
          # Check that PortIndex exists (created during port sync)
          if [ -f "/opt/local/var/macports/sources/github.com/macports/macports-ports/PortIndex" ]; then
            echo "âœ… PortIndex exists - git sources are functional"
          else
            echo "âŒ PortIndex not found - git sources may not be working"
            exit 1
          fi

          # Test 3: Verify variants were applied
          echo ""
          echo "Test 3: Variants configuration"
          VARIANTS_CONF="/opt/local/etc/macports/variants.conf"
          if [ -f "$VARIANTS_CONF" ]; then
            echo "variants.conf content:"
            cat "$VARIANTS_CONF"
            echo ""
            if grep -q '+doc' "$VARIANTS_CONF" && \
               grep -q '+x11' "$VARIANTS_CONF" && \
               grep -q '-universal' "$VARIANTS_CONF"; then
              echo "âœ… Variants configured correctly: +doc +x11 -universal"
            else
              echo "âŒ Variants don't match expected: +doc +x11 -universal"
              exit 1
            fi
          else
            echo "âŒ variants.conf not found"
            exit 1
          fi

          # Test 4: Verify MacPorts can query ports (basic functionality)
          echo ""
          echo "Test 4: MacPorts port query functionality"
          # Use 'port list' to verify sources are working
          # 'port info' without arguments tries to use current directory
          if OUTPUT=$(/opt/local/bin/port list 2>&1 | head -5); then
            echo "âœ… MacPorts port query is functional"
            echo "Sample ports:"
            echo "$OUTPUT"
          else
            echo "âŒ MacPorts port query failed"
            echo "Error output:"
            echo "$OUTPUT"
            exit 1
          fi

          echo ""
          echo "=== All functional tests passed ==="
          echo "Variants work, git sources are functional, configuration is applied"

  # Test sources providers
  test-sources-providers:
    name: Sources Provider ${{ matrix.provider }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'auto'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'git'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'auto'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'git'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'auto'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'git'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'rsync'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'auto'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'git'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'rsync'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.provider }} provider
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          sources-provider: '${{ matrix.provider }}'

      - name: Verify sources configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check sources.conf content
          echo "=== sources.conf content ==="
          cat /opt/local/etc/macports/sources.conf

          # Verify provider-specific configuration
          if [ "${{ matrix.provider }}" = "git" ]; then
            # Git provider should have local git sources
            grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf || exit 1
            # Verify git repository exists
            [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
            echo "âœ… Git provider configured correctly"
          elif [ "${{ matrix.provider }}" = "rsync" ]; then
            # Rsync provider should have rsync URL
            grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf || exit 1
            echo "âœ… Rsync provider configured correctly"
          else
            # Auto provider should have either git or rsync
            if grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf; then
              echo "âœ… Auto provider chose git"
            elif grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf; then
              echo "âœ… Auto provider chose rsync"
            else
              exit 1
            fi
          fi

  # Test signature validation modes
  test-signature-modes:
    name: Signature Mode ${{ matrix.mode }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'strict'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'disabled'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'permissive'
            skip-package: 'gdk-pixbuf2'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'strict'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'disabled'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'permissive'
            skip-package: 'gdk-pixbuf2'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'strict'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'disabled'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'permissive'
            skip-package: 'gdk-pixbuf2'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'strict'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'disabled'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'permissive'
            skip-package: 'gdk-pixbuf2'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.mode }} signature mode
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          signature-check: '${{ matrix.mode }}'
          skip-signature-check: '${{ matrix.skip-package }}'
          install-ports: '${{ matrix.skip-package }}'

      - name: Verify signature configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check macports.conf content
          echo "=== macports.conf signature_check setting ==="
          grep "signature_check" /opt/local/etc/macports/macports.conf
          echo ""

      - name: Test signature configuration
        run: |
          echo "=== Testing signature configuration ==="
          echo ""
          echo "Note: The original issue showed signature failures were caused by missing"
          echo "macports user/group during cache restore. With the fix, the macports user"
          echo "is created and signature verification works correctly."
          echo ""
          echo "This test verifies:"
          echo "  - strict mode:     signature_check is enabled in macports.conf"
          echo "  - disabled mode:   signature_check is disabled in macports.conf"
          echo "  - permissive mode: signature_check is enabled, specific packages use force flag"
          echo "  - The macports user/group are created when restoring from cache"
          echo ""

          # Verify the macports user and group exist
          echo "=== Verifying macports user/group ==="
          if dscl . -read /Groups/macports PrimaryGroupID >/dev/null 2>&1; then
            echo "âœ… macports group exists"
          else
            echo "âŒ macports group does NOT exist - fix not working!"
            exit 1
          fi

          if dscl . -list /Users/macports >/dev/null 2>&1; then
            echo "âœ… macports user exists"
          else
            echo "âŒ macports user does NOT exist - fix not working!"
            exit 1
          fi

          echo ""
          echo "=== Verifying signature configuration ==="

          if [ "${{ matrix.mode }}" = "strict" ]; then
            echo "Testing in STRICT mode - signature verification is ENABLED..."

            # Verify signature_check is enabled in config
            if grep -q "signature_check yes" /opt/local/etc/macports/macports.conf; then
              echo "âœ… signature_check is set to 'yes' in macports.conf"
            else
              echo "âŒ signature_check is not properly configured"
              exit 1
            fi

          elif [ "${{ matrix.mode }}" = "disabled" ]; then
            echo "Testing in DISABLED mode - signature verification is DISABLED..."

            # Verify signature_check is disabled in config
            if grep -q "signature_check no" /opt/local/etc/macports/macports.conf; then
              echo "âœ… signature_check is set to 'no' in macports.conf"
            else
              echo "âŒ signature_check is not properly configured"
              exit 1
            fi

          elif [ "${{ matrix.mode }}" = "permissive" ]; then
            echo "Testing in PERMISSIVE mode - signature verification is ENABLED with force flag for skipped packages..."

            # Verify signature_check is enabled in config (permissive keeps it enabled)
            if grep -q "signature_check yes" /opt/local/etc/macports/macports.conf; then
              echo "âœ… signature_check is set to 'yes' in macports.conf"
            else
              echo "âŒ signature_check is not properly configured"
              exit 1
            fi

            echo "âœ… Permissive mode configured - packages in skip list will use force flag"
          fi

          echo ""
          echo "âœ… Signature configuration test passed"

      - name: Verify MacPorts remains functional
        run: |
          echo ""
          /opt/local/bin/port version
          echo "âœ… MacPorts remains functional after signature test"

      - name: Verify permissive mode package installation
        if: matrix.mode == 'permissive'
        run: |
          echo "=== Verifying permissive mode package installation ==="
          echo ""

          # Check that the skipped package was installed
          if [ -n "${{ matrix.skip-package }}" ]; then
            echo "Checking if ${{ matrix.skip-package }} was installed..."

            # Verify package is installed
            if /opt/local/bin/port installed ${{ matrix.skip-package }} 2>/dev/null | grep -q "${{ matrix.skip-package }}"; then
              echo "âœ… Package ${{ matrix.skip-package }} is installed"
            else
              echo "âŒ Package ${{ matrix.skip-package }} was NOT installed"
              exit 1
            fi
          fi

          echo ""
          echo "âœ… Permissive mode package installation verified"
