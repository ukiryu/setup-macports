name: Test

on:
  push:
    branches: [main, master]
    paths-ignore: '**.md'
  pull_request:
    branches: [main, master]
    paths-ignore: '**.md'
  schedule:
    - cron: '30 3 * * 4'  # Weekly on Thursday
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Code style checks (separate job to avoid blocking quick tests)
  style-check:
    name: Code style checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format-check

  # Quick tests on all platforms
  quick-test:
    name: Quick tests (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20.x]
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  # Build verification
  build:
    name: Verify build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Compare dist
        run: |
          if [ "$(git diff --name-only | grep dist/ | wc -l)" -gt "0" ]; then
            echo "ðŸ” The following files have uncommitted changes:"
            git diff --name-only
            echo ""
            echo "ðŸ“¦ Dist folder size:"
            du -sh dist/
            echo ""
            echo "âš ï¸ Files changed since last commit:"
            git diff --stat
            exit 1
          fi

  # Comprehensive macOS tests with matrix
  test-macos:
    name: macOS ${{ matrix.label }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            version: '14'
            arch: 'arm64'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            version: '15'
            arch: 'arm64'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            version: '15'
            arch: 'x86_64'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            version: '26'
            arch: 'arm64'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Detect platform
        id: platform
        run: |
          echo "version=$(sw_vers -productVersion | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "macos_name=$(sw_vers -productName)" >> $GITHUB_OUTPUT

      - name: Test basic installation
        uses: ./
        with:
          macports-version: '2.11.5'
          debug: 'true'

      - name: Verify basic installation
        run: |
          set -x
          /opt/local/bin/port version
          [ -x /opt/local/bin/port ] || exit 1
          echo "âœ… Port binary exists and is executable"

      - name: Test with variants
        uses: ./
        with:
          macports-version: '2.11.5'
          variants: '+aqua +metal -x11'

      - name: Verify variants
        run: |
          set -x
          cat /opt/local/etc/macports/variants.conf
          # Check each variant exists in the file
          # Use -e flag for patterns starting with -
          grep -e '+aqua' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '+metal' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '-x11' /opt/local/etc/macports/variants.conf || exit 1
          echo "âœ… Variants configured correctly"

      - name: Test git sources
        uses: ./
        with:
          macports-version: '2.11.5'
          use-git-sources: 'true'

      - name: Verify git sources
        run: |
          # Check that the ports directory exists
          [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
          # Check that sources.conf points to the local copy
          grep -q 'file://.*macports-ports' /opt/local/etc/macports/sources.conf || exit 1
          echo "âœ… Git sources configured"

      - name: Test port installation
        uses: ./
        with:
          macports-version: '2.11.5'
          install-ports: 'git-lfs'

      - name: Verify port installation
        run: |
          /opt/local/bin/port installed git-lfs || echo "git-lfs installation failed (expected rsync permission issue)"
          # Verify action still works even if git-lfs fails
          /opt/local/bin/port version
          echo "âœ… MacPorts setup successful"

      - name: Display platform info
        run: |
          echo "Platform: ${{ steps.platform.outputs.macos_name }}"
          echo "Version: ${{ steps.platform.outputs.version }}"
          echo "Architecture: ${{ steps.platform.outputs.arch }}"
          echo "Runner: ${{ matrix.runner }}"

  # Test configuration outputs
  test-outputs:
    name: Configuration Outputs
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with variants and git sources
        id: setup
        uses: ./
        with:
          macports-version: '2.11.5'
          variants: '+aqua +metal -x11'
          use-git-sources: 'true'

      - name: Verify all outputs
        run: |
          echo "=== Basic Outputs ==="
          echo "Version: ${{ steps.setup.outputs.version }}"
          echo "Prefix: ${{ steps.setup.outputs.prefix }}"
          echo "Package URL: ${{ steps.setup.outputs.package-url }}"
          echo "Cache Key: ${{ steps.setup.outputs.cache-key }}"
          echo "Uses Git Sources: ${{ steps.setup.outputs.uses-git-sources }}"
          echo ""
          echo "=== Configuration Paths ==="
          echo "Variants Conf: ${{ steps.setup.outputs.variants-conf-path }}"
          echo "Sources Conf: ${{ steps.setup.outputs.sources-conf-path }}"
          echo "Ports Conf: ${{ steps.setup.outputs.ports-conf-path }}"
          echo "MacPorts Conf: ${{ steps.setup.outputs.macports-conf-path }}"
          echo ""
          echo "=== Configuration Values ==="
          echo "Configured Variants: ${{ steps.setup.outputs.configured-variants }}"
          echo "Configured Sources: ${{ steps.setup.outputs.configured-sources }}"
          echo ""
          echo "=== Source Locations ==="
          echo "Git Source Path: ${{ steps.setup.outputs.git-source-path }}"
          echo "Rsync Source URLs: ${{ steps.setup.outputs.rsync-source-urls }}"

      - name: Verify configuration files exist
        run: |
          # Verify all configuration files exist at output paths
          test -f "${{ steps.setup.outputs.variants-conf-path }}" || exit 1
          test -f "${{ steps.setup.outputs.sources-conf-path }}" || exit 1
          test -f "${{ steps.setup.outputs.macports-conf-path }}" || exit 1
          # Verify git source path exists
          test -d "${{ steps.setup.outputs.git-source-path }}" || exit 1
          # Verify variants content
          grep -q '+aqua' "${{ steps.setup.outputs.variants-conf-path }}" || exit 1
          grep -q '+metal' "${{ steps.setup.outputs.variants-conf-path }}" || exit 1
          grep -q '-x11' "${{ steps.setup.outputs.variants-conf-path }}" || exit 1
          echo "âœ… All configuration outputs verified"
          # Note: ports.conf is optional and not created by default

  # Test sources providers
  test-sources-providers:
    name: Sources Provider ${{ matrix.provider }}
    runs-on: macos-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        provider: ['auto', 'git', 'rsync']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.provider }} provider
        uses: ./
        with:
          macports-version: '2.11.5'
          sources-provider: '${{ matrix.provider }}'

      - name: Verify sources configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check sources.conf content
          echo "=== sources.conf content ==="
          cat /opt/local/etc/macports/sources.conf

          # Verify provider-specific configuration
          if [ "${{ matrix.provider }}" = "git" ]; then
            # Git provider should have local git sources
            grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf || exit 1
            # Verify git repository exists
            [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
            echo "âœ… Git provider configured correctly"
          elif [ "${{ matrix.provider }}" = "rsync" ]; then
            # Rsync provider should have rsync URL
            grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf || exit 1
            echo "âœ… Rsync provider configured correctly"
          else
            # Auto provider should have either git or rsync
            if grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf; then
              echo "âœ… Auto provider chose git"
            elif grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf; then
              echo "âœ… Auto provider chose rsync"
            else
              exit 1
            fi
          fi

  # Test signature validation modes
  test-signature-modes:
    name: Signature Mode ${{ matrix.mode }}
    runs-on: macos-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        mode: ['strict', 'disabled']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.mode }} signature mode
        uses: ./
        with:
          macports-version: '2.11.5'
          signature-check: '${{ matrix.mode }}'

      - name: Verify signature configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check macports.conf content
          echo "=== macports.conf content ==="
          cat /opt/local/etc/macports/macports.conf

          # Verify signature_check setting
          if [ "${{ matrix.mode }}" = "strict" ]; then
            grep -q "signature_check yes" /opt/local/etc/macports/macports.conf || exit 1
            echo "âœ… Strict mode: signature check enabled"
          elif [ "${{ matrix.mode }}" = "disabled" ]; then
            grep -q "signature_check no" /opt/local/etc/macports/macports.conf || exit 1
            echo "âœ… Disabled mode: signature check disabled"
          fi

  # Test custom prefix (experimental)
  test-custom-prefix:
    name: Custom Prefix (Experimental)
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup MacPorts with custom prefix
        uses: ./
        with:
          macports-version: '2.11.5'
          installation-prefix: '/tmp/macports-test'

      - name: Verify custom prefix installation
        run: |
          # Verify port binary exists at custom prefix
          # Note: Cannot run port binary due to hardcoded shebangs pointing to /opt/local
          test -x /tmp/macports-test/bin/port || exit 1
          test -f /tmp/macports-test/bin/port || exit 1

          # Verify configuration files at custom prefix
          test -f /tmp/macports-test/etc/macports/macports.conf || exit 1
          test -f /tmp/macports-test/etc/macports/sources.conf || exit 1
          test -f /tmp/macports-test/etc/macports/variants.conf || exit 1

          # Verify it's NOT in /opt/local
          ! test -f /opt/local/bin/port || exit 1

          # Verify prefix in macports.conf
          grep -q "prefix /tmp/macports-test" /tmp/macports-test/etc/macports/macports.conf || exit 1

          # Verify key directories were moved
          test -d /tmp/macports-test/bin || exit 1
          test -d /tmp/macports-test/sbin || exit 1
          test -d /tmp/macports-test/lib || exit 1
          test -d /tmp/macports-test/share || exit 1
          test -d /tmp/macports-test/var || exit 1

          echo "âœ… Custom prefix installation verified"
