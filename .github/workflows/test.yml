name: Test

on:
  push:
    branches: [main, master]
    paths-ignore: '**.md'
  pull_request:
    branches: [main, master]
    paths-ignore: '**.md'
  schedule:
    - cron: '30 3 * * 4'  # Weekly on Thursday
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # MacPorts version to use for testing
  # Change this value to test different MacPorts versions
  MACPORTS_VERSION: '2.12.0-rc1'

jobs:
  # Warm-up cache - runs once per platform to populate cache for all other jobs
  # Each platform has different cache keys (version/arch), so we run in parallel
  warm-up-cache:
    name: Warm-up cache (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts to populate cache
        id: setup
        uses: ./
        env:
          CACHE_SAVE_ONLY: 'true'
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          cache: 'true'

  # Code style checks (separate job to avoid blocking quick tests)
  style-check:
    name: Code style checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format-check

  # Quick tests on macOS (this action is macOS-only)
  quick-test:
    name: Quick tests (Node ${{ matrix.node-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
        node-version: [20.x]
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Run unit tests
        run: npm test

  # Build verification
  build:
    name: Verify build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Compare dist
        run: |
          if [ "$(git diff --name-only | grep dist/ | wc -l)" -gt "0" ]; then
            echo "üîç The following files have uncommitted changes:"
            git diff --name-only | grep dist/
            echo ""
            echo "üì¶ Dist folder size:"
            du -sh dist/
            echo ""
            echo "‚ö†Ô∏è Files changed since last commit:"
            git diff --stat -- 'dist/**'
            echo ""
            echo "‚ùå Detected uncommitted changes after build."
            echo "Please run 'npm run build' and commit the changes."
            exit 1
          fi
          echo "‚úÖ No uncommitted changes detected in dist/"

  # Comprehensive macOS tests with matrix
  test-macos:
    name: macOS ${{ matrix.label }}
    runs-on: ${{ matrix.runner }}
    needs: warm-up-cache
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            version: '14'
            arch: 'arm64'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            version: '15'
            arch: 'arm64'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            version: '15'
            arch: 'x86_64'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            version: '26'
            arch: 'arm64'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Detect platform
        id: platform
        run: |
          echo "version=$(sw_vers -productVersion | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "macos_name=$(sw_vers -productName)" >> $GITHUB_OUTPUT

      # ONE action call with all configurations
      - name: Setup MacPorts with all features
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'
          use-git-sources: 'true'
          install-ports: 'git-lfs inkscape'

      # Verify basic installation
      - name: Verify basic installation
        run: |
          set -x
          /opt/local/bin/port version
          [ -x /opt/local/bin/port ] || exit 1
          echo "‚úÖ Port binary exists and is executable"

      # Verify variants
      - name: Verify variants
        run: |
          set -x
          cat /opt/local/etc/macports/variants.conf
          grep -e '+doc' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '+x11' /opt/local/etc/macports/variants.conf || exit 1
          grep -e '-universal' /opt/local/etc/macports/variants.conf || exit 1
          echo "‚úÖ Variants configured correctly"

      # Verify git sources
      - name: Verify git sources
        run: |
          [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
          grep -q 'file://.*macports-ports' /opt/local/etc/macports/sources.conf || exit 1
          echo "‚úÖ Git sources configured"

      # Verify port installation - test actual CLI functionality
      - name: Verify port installation
        run: |
          echo "=== Verifying CLI functionality ==="
          echo "Note: Some ports may fail activation due to LaunchDaemon permissions in CI"
          echo "We test whether the CLI binary exists and is executable"

          # Test git-lfs CLI
          echo ""
          echo "Testing git-lfs:"
          if [ -x /opt/local/bin/git-lfs ]; then
            git-lfs --version
            echo "‚úÖ git-lfs CLI works"
          else
            echo "‚ö†Ô∏è git-lfs CLI not found (activation may have failed due to permissions)"
          fi

          # Test inkscape CLI
          echo ""
          echo "Testing inkscape:"
          if [ -x /opt/local/bin/inkscape ]; then
            inkscape --version 2>/dev/null || inkscape --help 2>&1 | head -3
            echo "‚úÖ Inkscape CLI exists"
          else
            echo "‚ö†Ô∏è Inkscape CLI not found (complex port with many dependencies, may have failed)"
          fi

          # Verify MacPorts itself works regardless of port installation results
          echo ""
          /opt/local/bin/port version
          echo "‚úÖ MacPorts setup successful"

      - name: Display platform info
        run: |
          echo "Platform: ${{ steps.platform.outputs.macos_name }}"
          echo "Version: ${{ steps.platform.outputs.version }}"
          echo "Architecture: ${{ steps.platform.outputs.arch }}"
          echo "Runner: ${{ matrix.runner }}"

  # Test configuration outputs
  test-outputs:
    name: Configuration Outputs (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with variants and git sources
        id: setup
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          variants: '+doc +x11 -universal'
          use-git-sources: 'true'

      - name: Test variants and git sources functionality
        run: |
          echo "=== Functional Test: Variants + Git Sources ==="
          echo ""
          echo "This test verifies:"
          echo "1. Variants system is functional"
          echo "2. Git sources are being used"
          echo "3. Configuration is applied correctly"
          echo ""

          # Test 1: Verify git sources are configured
          echo "Test 1: Git sources configuration"
          SOURCES_CONF="/opt/local/etc/macports/sources.conf"
          echo "sources.conf content:"
          cat "$SOURCES_CONF"
          echo ""
          if grep -q "file://.*/macports-ports" "$SOURCES_CONF"; then
            echo "‚úÖ Git sources are configured in sources.conf"
          else
            echo "‚ùå Git sources not configured in sources.conf"
            echo "Content:"
            cat "$SOURCES_CONF"
            exit 1
          fi

          # Test 2: Verify git sources are functional by checking PortIndex
          echo ""
          echo "Test 2: Git sources are functional"
          # Check that PortIndex exists (created during port sync)
          if [ -f "/opt/local/var/macports/sources/github.com/macports/macports-ports/PortIndex" ]; then
            echo "‚úÖ PortIndex exists - git sources are functional"
          else
            echo "‚ùå PortIndex not found - git sources may not be working"
            exit 1
          fi

          # Test 3: Verify variants were applied
          echo ""
          echo "Test 3: Variants configuration"
          VARIANTS_CONF="/opt/local/etc/macports/variants.conf"
          if [ -f "$VARIANTS_CONF" ]; then
            echo "variants.conf content:"
            cat "$VARIANTS_CONF"
            echo ""
            if grep -q '+doc' "$VARIANTS_CONF" && \
               grep -q '+x11' "$VARIANTS_CONF" && \
               grep -q '-universal' "$VARIANTS_CONF"; then
              echo "‚úÖ Variants configured correctly: +doc +x11 -universal"
            else
              echo "‚ùå Variants don't match expected: +doc +x11 -universal"
              exit 1
            fi
          else
            echo "‚ùå variants.conf not found"
            exit 1
          fi

          # Test 4: Verify MacPorts can query ports (basic functionality)
          echo ""
          echo "Test 4: MacPorts port query functionality"
          # Use 'port list' to verify sources are working
          # 'port info' without arguments tries to use current directory
          if OUTPUT=$(/opt/local/bin/port list 2>&1 | head -5); then
            echo "‚úÖ MacPorts port query is functional"
            echo "Sample ports:"
            echo "$OUTPUT"
          else
            echo "‚ùå MacPorts port query failed"
            echo "Error output:"
            echo "$OUTPUT"
            exit 1
          fi

          echo ""
          echo "=== All functional tests passed ==="
          echo "Variants work, git sources are functional, configuration is applied"

  # Test sources providers
  test-sources-providers:
    name: Sources Provider ${{ matrix.provider }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'auto'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'git'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'auto'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'git'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            provider: 'rsync'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'auto'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'git'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            provider: 'rsync'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'auto'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'git'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            provider: 'rsync'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.provider }} provider
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          sources-provider: '${{ matrix.provider }}'

      - name: Verify sources configuration
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check sources.conf content
          echo "=== sources.conf content ==="
          cat /opt/local/etc/macports/sources.conf

          # Verify provider-specific configuration
          if [ "${{ matrix.provider }}" = "git" ]; then
            # Git provider should have local git sources
            grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf || exit 1
            # Verify git repository exists
            [ -d /opt/local/var/macports/sources/github.com/macports/macports-ports ] || exit 1
            echo "‚úÖ Git provider configured correctly"
          elif [ "${{ matrix.provider }}" = "rsync" ]; then
            # Rsync provider should have rsync URL
            grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf || exit 1
            echo "‚úÖ Rsync provider configured correctly"
          else
            # Auto provider should have either git or rsync
            if grep -q "file://.*macports-ports" /opt/local/etc/macports/sources.conf; then
              echo "‚úÖ Auto provider chose git"
            elif grep -q "rsync://.*ports.tar" /opt/local/etc/macports/sources.conf; then
              echo "‚úÖ Auto provider chose rsync"
            else
              exit 1
            fi
          fi

  # Test signature validation modes
  test-signature-modes:
    name: Signature Mode ${{ matrix.mode }} (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    needs: warm-up-cache
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS 14 Sonoma (ARM64)
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'strict'
          - runner: macos-14
            label: '14-Sonoma-ARM'
            mode: 'disabled'
          # macOS 15 Sequoia (ARM64)
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'strict'
          - runner: macos-15
            label: '15-Sequoia-ARM'
            mode: 'disabled'
          # macOS 15 Sequoia (Intel x64)
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'strict'
          - runner: macos-15-intel
            label: '15-Sequoia-Intel'
            mode: 'disabled'
          # macOS 26 Tahoe (ARM64)
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'strict'
          - runner: macos-26
            label: '26-Tahoe-ARM'
            mode: 'disabled'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install dependencies
        run: |
          for i in {1..3}; do
            npm ci && break || sleep 10
          done

      - name: Build
        run: npm run build

      - name: Setup MacPorts with ${{ matrix.mode }} signature mode
        uses: ./
        with:
          macports-version: ${{ env.MACPORTS_VERSION }}
          signature-check: '${{ matrix.mode }}'

      - name: Verify signature enforcement
        run: |
          # Verify MacPorts is installed
          /opt/local/bin/port version

          # Check macports.conf content
          echo "=== macports.conf signature_check setting ==="
          grep "signature_check" /opt/local/etc/macports/macports.conf
          echo ""

          echo "=== Testing signature enforcement with inkscape (known broken signature) ==="
          echo "inkscape has a broken/invalid signature - perfect for testing!"
          echo ""
          echo "Expected behavior:"
          echo "  - strict mode:   should FAIL (rejects port with broken signature)"
          echo "  - disabled mode: should SUCCEED (ignores signature issues)"
          echo ""

          if [ "${{ matrix.mode }}" = "strict" ]; then
            echo "Testing in strict mode - expecting FAILURE due to broken signature..."
            if /opt/local/bin/port install inkscape 2>&1 | tee /tmp/install.log; then
              echo ""
              echo "‚ö†Ô∏è UNEXPECTED: Installation succeeded in strict mode!"
              echo "   (Maybe inkscape's signature was fixed, or enforcement not working)"
            else
              echo ""
              echo "‚úÖ EXPECTED: Installation failed in strict mode (signature rejected)"
              echo "   This proves signature enforcement is WORKING!"
              echo ""
              echo "Error log:"
              grep -i "signature\|verify\|invalid" /tmp/install.log || tail -5 /tmp/install.log
            fi
          elif [ "${{ matrix.mode }}" = "disabled" ]; then
            echo "Testing in disabled mode - expecting SUCCESS (signatures ignored)..."
            echo "Note: May still fail due to other issues (dependencies, permissions)"
            if /opt/local/bin/port install inkscape 2>&1 | tee /tmp/install.log; then
              echo ""
              echo "‚úÖ Installation succeeded in disabled mode!"
              if [ -x /opt/local/bin/inkscape ]; then
                echo "‚úÖ inkscape CLI is executable"
                /opt/local/bin/inkscape --version 2>/dev/null || /opt/local/bin/inkscape --help 2>&1 | head -2
              fi
            else
              echo ""
              echo "‚ö†Ô∏è Installation failed (may be due to permissions, dependencies, or network)"
              echo "   But NOT due to signature verification (disabled)"
              tail -10 /tmp/install.log
            fi
          fi

          echo ""
          /opt/local/bin/port version
          echo "‚úÖ MacPorts remains functional"
